

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>SpecUFEx Example: The Geysers, California &mdash; specufex 0.1.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "tex2jax_ignore|mathjax_ignore|document", "processClass": "tex2jax_process|mathjax_process|math|output_area"}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Examples" href="examples.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> specufex
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="specufex.html">SpecUFEx</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">SpecUFEx Example: The Geysers, California</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Tutorial-Steps">Tutorial Steps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Imports">Imports</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Load-waveforms">Load waveforms</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Create-spectrograms">Create spectrograms</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Set-spectrogram-parameters">Set spectrogram parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Calculate-spectrograms-and-convert-to-dB">Calculate spectrograms and convert to dB</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Run-specufex">Run specufex</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Fitting-models-and-transforming-data">Fitting models and transforming data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Probabilistic-nonegative-matrix-factorization">Probabilistic nonegative matrix factorization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Probabilistic-Hidden-Markov-Model">Probabilistic Hidden Markov Model</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Cluster-fingerprints-with-Kmeans">Cluster fingerprints with Kmeans</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Plot-clusters-over-time-(2012-2014)">Plot clusters over time (2012-2014)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Compare-to-Figure-3c-from-Holtzman-et-al.,-2018">Compare to Figure 3c from Holtzman et al., 2018</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">specufex</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="examples.html">Examples</a> &raquo;</li>
        
      <li>SpecUFEx Example: The Geysers, California</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/example_geysers.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="SpecUFEx-Example:-The-Geysers,-California">
<h1>SpecUFEx Example: The Geysers, California<a class="headerlink" href="#SpecUFEx-Example:-The-Geysers,-California" title="Permalink to this headline">¶</a></h1>
<p>Written by Theresa Sawi and Nate Groebner</p>
<p>Based on the study <strong>Machine learning reveals cyclic changes in seismic source spectra in Geysers geothermal field</strong> by Holtzman et al., 2018. DOI 10.1126/sciadv.aao2929</p>
<p>This example walks through fitting a SpecUFEx model to seismograms of approximately 46,000 microearthquakes from The Geysers geothermal field in California from 2012 to 2014. Using the features extracted by SpecUFEx, k-means clustering identifies 4 clusters of earthquake patterns that are correlated to rate of water flow into the injection wells.</p>
<div class="section" id="Tutorial-Steps">
<h2>Tutorial Steps<a class="headerlink" href="#Tutorial-Steps" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>Read in waveforms from hdf5 file.</p></li>
<li><p>Convert waveforms to spectrograms (filtered and median normalized)</p></li>
<li><p>Run SpecUFEx on spectrograms: Nonnegative matrix factorization followed by hidden markov model</p></li>
<li><p>Do kmeans clustering on SpecUFEx fingerprints</p></li>
<li><p>Compare clusters to paper figure 3c</p></li>
</ol>
<div class="section" id="Imports">
<h3>Imports<a class="headerlink" href="#Imports" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span><span class="p">,</span> <span class="n">trange</span>

<span class="kn">from</span> <span class="nn">specufex</span> <span class="kn">import</span> <span class="n">BayesianNonparametricNMF</span><span class="p">,</span> <span class="n">BayesianHMM</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Load-waveforms">
<h2>Load waveforms<a class="headerlink" href="#Load-waveforms" title="Permalink to this headline">¶</a></h2>
<p>The waveforms are saved to an hdf5 file. The waveforms and their IDs are loaded into numpy arrays and then stored in a pandas dataframe for easier manipulation.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s2">&quot;./data/geysers/all_waveforms.h5&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">traces</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;waveforms&quot;</span><span class="p">][()]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;event_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asstr</span><span class="p">()[()]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;{len(traces)} waveforms in file&quot;</span><span class="p">)</span>

<span class="n">cat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="n">names</span><span class="p">,</span><span class="s2">&quot;trace&quot;</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="n">traces</span><span class="p">)})</span>
<span class="n">cat</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
45918 waveforms in file
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>trace</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>SQK.BG.DPZ..D.2012.001.001850</td>
      <td>[9.366470582736789e-08, 7.655206533462191e-08,...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>SQK.BG.DPZ..D.2012.001.002355</td>
      <td>[7.404378429170258e-08, 6.503093421575965e-08,...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>SQK.BG.DPZ..D.2012.001.004045</td>
      <td>[4.2386264788434286e-08, 4.1953521799737826e-0...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>SQK.BG.DPZ..D.2012.001.010620</td>
      <td>[3.2988539628874798e-09, 8.042296180480629e-09...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>SQK.BG.DPZ..D.2012.001.012322</td>
      <td>[7.769589230310885e-08, 7.198216536693702e-08,...</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>
<div class="section" id="Create-spectrograms">
<h2>Create spectrograms<a class="headerlink" href="#Create-spectrograms" title="Permalink to this headline">¶</a></h2>
<div class="section" id="Set-spectrogram-parameters">
<h3>Set spectrogram parameters<a class="headerlink" href="#Set-spectrogram-parameters" title="Permalink to this headline">¶</a></h3>
<p>These parameters control spectrogram generation. Two parameters, fs (sampling rate) and len_data (number of samples of a waveform) depend on the data themselves. All waveforms must have the same number of samples. See <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.spectrogram.html">https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.spectrogram.html</a> for more information about the parameters.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># waveform parameters</span>
<span class="n">fs</span> <span class="o">=</span> <span class="mi">500</span> <span class="c1"># Hz, sampling rate</span>
<span class="n">len_data</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="c1"># bandpass filter</span>
<span class="n">fMin</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># Hz</span>
<span class="n">fMax</span> <span class="o">=</span> <span class="mi">150</span> <span class="c1">#Hz</span>

<span class="c1"># spectrogram parameters</span>
<span class="n">sgramMode</span><span class="o">=</span><span class="s1">&#39;magnitude&#39;</span>
<span class="n">sgramScaling</span><span class="o">=</span><span class="s1">&#39;spectrum&#39;</span>

<span class="c1"># frequency/time resolution</span>
<span class="n">nperseg</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">noverlap</span> <span class="o">=</span> <span class="n">nperseg</span><span class="o">/</span><span class="mi">4</span>
<span class="n">nfft</span> <span class="o">=</span> <span class="mi">1024</span>
<br/><br/></pre></div>
</div>
</div>
</div>
<div class="section" id="Calculate-spectrograms-and-convert-to-dB">
<h3>Calculate spectrograms and convert to dB<a class="headerlink" href="#Calculate-spectrograms-and-convert-to-dB" title="Permalink to this headline">¶</a></h3>
<p>The NMF algorithm requires that all spectrograms contain nonnegative values. The following procedure normalizes each spectrogram individually and ensures element-wise nonnegativity.</p>
<p>Calculate raw spectrograms using scipy:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fSTFT</span><span class="p">,</span> <span class="n">tSTFT</span><span class="p">,</span> <span class="n">STFT_raw</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;trace&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
    <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span>
    <span class="n">nperseg</span><span class="o">=</span><span class="n">nperseg</span><span class="p">,</span>
    <span class="n">noverlap</span><span class="o">=</span><span class="n">noverlap</span><span class="p">,</span>
    <span class="n">nfft</span><span class="o">=</span><span class="n">nfft</span><span class="p">,</span>
    <span class="n">scaling</span><span class="o">=</span><span class="n">sgramScaling</span><span class="p">,</span>
    <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="n">sgramMode</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Quality check to see if any elements are NaN.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">STFT_raw</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
False
</pre></div></div>
</div>
<p><em>Optional step</em>: Select a frequency band from the spectrograms</p>
<p>Some applications benefit from discarding low and/or high frequency data from the spectrograms, e.g. if there is significant high frequency noise. The following applies a bandpass filter to the data in the frequency domain.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">freq_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">fSTFT</span> <span class="o">&gt;=</span> <span class="n">fMin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">fSTFT</span> <span class="o">&lt;=</span> <span class="n">fMax</span><span class="p">))</span>
<span class="n">fSTFT</span>   <span class="o">=</span> <span class="n">fSTFT</span><span class="p">[</span><span class="n">freq_slice</span><span class="p">]</span>
<span class="n">STFT_0</span> <span class="o">=</span> <span class="n">STFT_raw</span><span class="p">[:,</span><span class="n">freq_slice</span><span class="p">,:]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Next, we normalize each spectrogram by its median and convert to dB. This creates a matrix where about half of the nonzero entries are negative and half are positive. All of the negative entries are then set to zero, ensuring that the NMF algorithm has valid, nonnegative data. It also has the effect of throwing away half of the data, the half that is below the median dB value.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">normConstant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">STFT_0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">STFT_norm</span> <span class="o">=</span> <span class="n">STFT_0</span> <span class="o">/</span> <span class="n">normConstant</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># norm by median</span>
<span class="k">del</span> <span class="n">STFT_0</span>
<span class="n">STFT_dB</span> <span class="o">=</span> <span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">STFT_norm</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">STFT_norm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># convert to dB</span>
<span class="k">del</span> <span class="n">STFT_norm</span>
<span class="n">STFT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">STFT_dB</span><span class="p">)</span> <span class="c1"># make sure nonnegative</span>
<span class="k">del</span> <span class="n">STFT_dB</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;stft&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">STFT</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Another quality check.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bad_idx</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;stft&quot;</span><span class="p">][</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;stft&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">())]</span><span class="o">.</span><span class="n">index</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bad spectrograms: </span><span class="se">\n</span><span class="si">{cat.loc[bad_idx].name}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">cat</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">bad_idx</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Bad spectrograms:
Series([], Name: name, dtype: object)
</pre></div></div>
</div>
<p>Plotted below is a raw spectrogram and its normalized counterpart. Notice how the overall dynamic range of spectrogram is compressed.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_spectrogram</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># index of spectrogram to plot</span>

<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">tSTFT</span><span class="p">,</span><span class="n">fSTFT</span><span class="p">,</span><span class="n">STFT_raw</span><span class="p">[</span><span class="n">n_spectrogram</span><span class="p">,</span><span class="n">freq_slice</span><span class="p">,:]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Timestep&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency (Hz)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original spectrogram&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">tSTFT</span><span class="p">,</span><span class="n">fSTFT</span><span class="p">,</span> <span class="n">STFT</span><span class="p">[</span><span class="n">n_spectrogram</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Timestep&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Normalized spectrogram&quot;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;Normalized spectrogram&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/example_geysers_19_1.png" src="_images/example_geysers_19_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="Run-specufex">
<h2>Run specufex<a class="headerlink" href="#Run-specufex" title="Permalink to this headline">¶</a></h2>
<div class="section" id="Fitting-models-and-transforming-data">
<h3>Fitting models and transforming data<a class="headerlink" href="#Fitting-models-and-transforming-data" title="Permalink to this headline">¶</a></h3>
<p>SpecUFEx fits a group of spectrograms, where D is the number of rows (frequency bands) and M is the number of columns (timesteps) in each spectrogram. The spectrograms must be in a numpy-compatible matrix of dimension, N being the number of spectrograms in the dataset. Each spectrogram must consist of all nonnegative (&gt;=0) entries</p>
<p>The two main classes in this package are <code class="docutils literal notranslate"><span class="pre">BayesianNonparametricNMF</span></code> and <code class="docutils literal notranslate"><span class="pre">BayesianHMM</span></code>. Each has fit, transform, and fit_transform methods to be consistent with the Scikit-learn API style.</p>
</div>
<div class="section" id="Probabilistic-nonegative-matrix-factorization">
<h3>Probabilistic nonegative matrix factorization<a class="headerlink" href="#Probabilistic-nonegative-matrix-factorization" title="Permalink to this headline">¶</a></h3>
<p>The first step in the specufex algorithm is to decompose the set of spectrograms into a single, common “dictionary” matrix and a set of “activation matrices”, one for each spectrogram. The <code class="docutils literal notranslate"><span class="pre">BayesianNonParametricNMF</span></code> class implements a probabilistic hierarchical Bayesian model for estimating this decomposition.</p>
<p>First instantiate the nmf model. The constructor takes a tuple with the dimensions of the spectrogram matrix.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nmf</span> <span class="o">=</span> <span class="n">BayesianNonparametricNMF</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;stft&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The model is fit in a loop. In our case, we use 100,000 batches with batch size of 1.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batches</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">trange</span><span class="p">(</span><span class="n">batches</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;NMF fit progress &quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;stft&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="n">nmf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;stft&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">set_postfix_str</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Patterns: </span><span class="si">{nmf.num_pat}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
NMF fit progress : 100%|██████████| 100000/100000 [1:15:50&lt;00:00, 21.97it/s, Patterns: 45]
</pre></div></div>
</div>
<p>The estimated dictionary matrix is plotted below.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">nmf</span><span class="o">.</span><span class="n">EW</span><span class="nd">@np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">nmf</span><span class="o">.</span><span class="n">EA</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;NMF pattern number&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nmf</span><span class="o">.</span><span class="n">num_pat</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nmf</span><span class="o">.</span><span class="n">num_pat</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency (Hz)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/example_geysers_26_0.png" src="_images/example_geysers_26_0.png" />
</div>
</div>
<p>Next, the <code class="docutils literal notranslate"><span class="pre">transform</span></code> method of the<code class="docutils literal notranslate"><span class="pre">BayesianNonparametricNMF</span></code> class is used to find the activation matrices, Vs, for each spectrogram.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vs</span> <span class="o">=</span> <span class="n">nmf</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;stft&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="c1"># save Vs to an hdf5</span>
<span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s2">&quot;data/geysers/Vs.h5&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="p">[</span><span class="s2">&quot;Vs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vs</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s2">&quot;data/geysers/Vs.h5&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">Vs</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;Vs&quot;</span><span class="p">][()]</span>
</pre></div>
</div>
</div>
<p>Here is an example activation matrix, plotted with the correpsonding</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">Vs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Timestep&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;NMF pattern&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nmf</span><span class="o">.</span><span class="n">num_pat</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nmf</span><span class="o">.</span><span class="n">num_pat</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/example_geysers_31_0.png" src="_images/example_geysers_31_0.png" />
</div>
</div>
<p>Remember that this is a matrix factorization problem so, the dictionary matrix times the activation matrix should produce an estimate of the original spectrogram. Below is a figure illustrating this.</p>
</div>
<div class="section" id="Probabilistic-Hidden-Markov-Model">
<h3>Probabilistic Hidden Markov Model<a class="headerlink" href="#Probabilistic-Hidden-Markov-Model" title="Permalink to this headline">¶</a></h3>
<p>A hidden Markov model describes a system where a sequence of observations is produced by hidden, or unobservable, states. In our case, the frequency components of each timestep in a spectrogram is assumed to be emitted with a particular probability by one of the hidden states. The code fits an HMM model to the spectrograms, and for each timestep calculates the most probable hidden state that produced the frequency pattern.</p>
<p>The HMM model is created using the <code class="docutils literal notranslate"><span class="pre">BayesianHMM</span></code> class. Currently, in order to setup the object correctly the number of NMF patterns (num_pat) and the gain calculated by <code class="docutils literal notranslate"><span class="pre">BayesianNonparametricNMF</span></code> are passed to the constructor. Similar to the NMF calculation, the data are transformed to fingerprints with the transform function.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nmf</span> <span class="o">=</span> <span class="n">BayesianNonparametricNMF</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;data/geysers/nmf.h5&quot;</span><span class="p">)</span>

<span class="n">num_states</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">hmm</span> <span class="o">=</span> <span class="n">BayesianHMM</span><span class="p">(</span><span class="n">nmf</span><span class="o">.</span><span class="n">num_pat</span><span class="p">,</span> <span class="n">nmf</span><span class="o">.</span><span class="n">gain</span><span class="p">,</span> <span class="n">num_state</span><span class="o">=</span><span class="n">num_states</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">46000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batches</span> <span class="o">=</span> <span class="mi">75000</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">trange</span><span class="p">(</span><span class="n">batches</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;HMM fit progress &quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">Vs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">hmm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Vs</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
HMM fit progress : 100%|██████████| 75000/75000 [32:59&lt;00:00, 37.89it/s]
</pre></div></div>
</div>
<p>The <em>emmission matrix</em> of the HMM relates the hidden state to the expected value of each frequency emitted by that state. Below is the calculated emmissions matrix for our model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">hmm</span><span class="o">.</span><span class="n">EB</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;HMM state&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Frequency pattern&quot;</span><span class="p">)</span>
<span class="n">_</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">num_states</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_states</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/example_geysers_38_0.png" src="_images/example_geysers_38_0.png" />
</div>
</div>
<p>Next step is to calculate the “fingerprints”, which are the final features calculated by the SpecUFEx algorithm. ?The fingerprints are a statistical representation of how likely each state transition is for each individual spectrogram.</p>
<p>Below, the <code class="docutils literal notranslate"><span class="pre">.transform()</span></code> method is used to calculate the fingerprints. It also returns a state transition count matrix (<code class="docutils literal notranslate"><span class="pre">As</span></code>) and the state sequence matrix (<code class="docutils literal notranslate"><span class="pre">gams</span></code>).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fingerprints</span><span class="p">,</span> <span class="n">As</span><span class="p">,</span> <span class="n">gams</span> <span class="o">=</span> <span class="n">hmm</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Vs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Example of a fingerprint. Each entry in the matrix is the probability that, for the corresponding spectrogram, a given state transitions to another state.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fingerprints</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.image.AxesImage at 0x16ac71790&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/example_geysers_42_1.png" src="_images/example_geysers_42_1.png" />
</div>
</div>
<p>And this is the state transition matrix. This is the actual temporal order of probabilities that the system was in a given state when it emitted the frequencies.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">gams</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time step&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Hidden State&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/example_geysers_44_0.png" src="_images/example_geysers_44_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="Cluster-fingerprints-with-Kmeans">
<h2>Cluster fingerprints with Kmeans<a class="headerlink" href="#Cluster-fingerprints-with-Kmeans" title="Permalink to this headline">¶</a></h2>
<p>The SpecUFEx procedure reduces a set of waveforms/spectrograms to a set of feature matrices. These features can then be used as input to a machine learning algorithm. In this example, we use the features for unsupervised clustering of similar fingerprints.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># convert fingerprints from 2D array to 1D array</span>
<span class="n">fingerprints_</span> <span class="o">=</span> <span class="n">fingerprints</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">fingerprints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fingerprints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

<span class="c1">#Predicted labels</span>
<span class="n">K</span><span class="o">=</span><span class="mi">4</span> <span class="c1"># number of clusters to fit</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">K</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">fingerprints_</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Plot-clusters-over-time-(2012-2014)">
<h2>Plot clusters over time (2012-2014)<a class="headerlink" href="#Plot-clusters-over-time-(2012-2014)" title="Permalink to this headline">¶</a></h2>
<p>We now compare the clusters from our fit to the results from the reference above. The following code plots the frequency of earthquakes in each cluster over time.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">date_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">doy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">19</span><span class="p">:</span><span class="mi">22</span><span class="p">])</span>
    <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">14</span><span class="p">:</span><span class="mi">18</span><span class="p">])</span>

    <span class="n">date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">doy</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">date_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fingerprints_</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_list</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_list</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span>
<span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date_index&quot;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="n">timeBin</span><span class="o">=</span><span class="s2">&quot;M&quot;</span> <span class="c1">#calculate number of events per month</span>
<span class="n">barWidth</span><span class="o">=.</span><span class="mi">1</span>


<span class="n">barHeightsPadList</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">barHeightsPadListNorm</span> <span class="o">=</span> <span class="p">[]</span>


<span class="n">normBars</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># normalize colors by cluster maximum</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>

    <span class="n">clus_events</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">Cluster</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span>

    <span class="n">barHeights</span> <span class="o">=</span> <span class="n">clus_events</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">timeBin</span><span class="p">)</span><span class="o">.</span><span class="n">Cluster</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="c1">## pad bars if they start in later months or end in earlier months</span>
    <span class="n">startFill</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="n">barHeights</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">freq</span><span class="o">=</span><span class="n">timeBin</span><span class="p">)</span>
    <span class="n">endFill</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">barHeights</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">freq</span><span class="o">=</span><span class="n">timeBin</span><span class="p">)</span>
    <span class="n">startFillZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">startFill</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
    <span class="n">endFillZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">endFill</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
    <span class="n">barHeightsPad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">startFillZ</span><span class="p">,</span><span class="n">barHeights</span><span class="p">])</span>
    <span class="n">barHeightsPad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">barHeightsPad</span><span class="p">,</span><span class="n">endFillZ</span><span class="p">])</span>
    <span class="n">barHeightsPadNorm</span> <span class="o">=</span> <span class="n">barHeightsPad</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">barHeightsPad</span><span class="p">)</span>

    <span class="n">barHeightsPadList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">barHeightsPad</span><span class="p">)</span>
    <span class="n">barHeightsPadListNorm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">barHeightsPadNorm</span><span class="p">)</span>



<span class="n">barHeights_ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">barHeightsPadList</span><span class="p">)</span>
<span class="n">barHeights_arNorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">barHeightsPadListNorm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Compare-to-Figure-3c-from-Holtzman-et-al.,-2018">
<h3>Compare to Figure 3c from Holtzman et al., 2018<a class="headerlink" href="#Compare-to-Figure-3c-from-Holtzman-et-al.,-2018" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">barHeights_ar</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">Oranges</span><span class="p">,</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">#Values to anchor the colormap, otherwise they are inferred from the data and other keyword arguments.</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">barHeightsPadList</span><span class="p">),</span>
            <span class="n">square</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Observations </span><span class="se">\n</span><span class="s1"> per hour&#39;</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">,</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">3.5</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (months since Jan 2012)&#39;</span><span class="p">)</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s2">&quot;./figures/holtzman2018_figure.png&quot;</span><span class="p">)</span>
<span class="c1">#plt.figure(figsize=(10,10))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/example_geysers_51_0.png" src="_images/example_geysers_51_0.png" />
</div>
</div>
<p>Not too bad! Do note that the clusters are assigned numbers randomly - one cluster that we calculated may correspond to a different cluster number in the figure. Also, the algorithm is probabilistic, so the results won’t be perfectly similar, and different runs with the same parameters may produce slightly different results.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="examples.html" class="btn btn-neutral float-left" title="Examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Specufex team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>